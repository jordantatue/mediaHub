---
import Layout from '../layouts/Layout.astro';
import ArticleCard from '../components/ArticleCard.astro';
import { getCollection } from 'astro:content';

const sortedPosts = (await getCollection('posts')).sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

const heroImages = [
  {
    src: '/images/hero/hero-architecture.jpg',
    alt: 'Perspective architecturale moderne et lumineuse',
  },
  {
    src: '/images/hero/hero-technology.jpg',
    alt: 'Ambiance technologique avec lumière bleutée',
  },
  {
    src: '/images/hero/hero-culture.jpg',
    alt: 'Scène culturelle immersive et chaleureuse',
  },
  {
    src: '/images/hero/hero-travel.jpg',
    alt: 'Paysage de voyage inspirant au lever du jour',
  },
];
---

<Layout>
  <section class="mb-5">
    <div
      id="heroCarousel"
      class="carousel slide carousel-fade"
      data-bs-ride="carousel"
      data-bs-interval="5500"
    >
      <div class="carousel-indicators">
        {heroImages.map((_, index) => (
          <button
            type="button"
            data-bs-target="#heroCarousel"
            data-bs-slide-to={index}
            class:list={[{ active: index === 0 }]}
            aria-current={index === 0 ? 'true' : undefined}
            aria-label={`Slide ${index + 1}`}
          />
        ))}
      </div>

      <div class="carousel-inner">
        {heroImages.map((image, index) => (
          <div
            class:list={['carousel-item position-relative', { active: index === 0 }]}
            style="height: 360px;"
          >
            <img
              src={image.src}
              alt={image.alt}
              class="d-block w-100 h-100 object-fit-cover"
              loading={index === 0 ? 'eager' : 'lazy'}
              decoding="async"
            />
            <div class="position-absolute top-0 start-0 w-100 h-100 bg-dark bg-opacity-50 pe-none"></div>
            <div class="position-absolute top-0 start-0 w-100 h-100 d-flex flex-column align-items-center justify-content-center text-center p-4 z-2">
              <span class="badge text-bg-primary text-uppercase mb-3">Bienvenue</span>
              <h1 class="display-4 fw-bold text-white mb-3">Bienvenue sur MediaHub</h1>
              <p class="lead text-white mb-4 w-75 mx-auto">
                Découvrez les dernières actualités et articles sur les sujets qui vous passionnent.
                Restez informé avec notre contenu de qualité.
              </p>
              <a href="#dernieres-articles" class="btn btn-light btn-sm px-3 py-2">
                Découvrir les articles
              </a>
            </div>
          </div>
        ))}
      </div>

      <button class="carousel-control-prev" type="button" data-bs-target="#heroCarousel" data-bs-slide="prev">
        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
        <span class="visually-hidden">Précédent</span>
      </button>
      <button class="carousel-control-next" type="button" data-bs-target="#heroCarousel" data-bs-slide="next">
        <span class="carousel-control-next-icon" aria-hidden="true"></span>
        <span class="visually-hidden">Suivant</span>
      </button>
    </div>
  </section>

  <section class="py-5">
    <div class="container">
      <h2 id="dernieres-articles" class="mb-4">Derniers articles</h2>

      <div class="row g-4">
        {sortedPosts.map((post) => (
          <div class="col-12 col-md-6 col-lg-4" data-titre-article={post.data.title.toLowerCase()}>
            <ArticleCard
              title={post.data.title}
              date={post.data.date}
              category={post.data.category}
              excerpt={post.data.excerpt}
              source={post.data.source}
              slug={post.slug}
              image={post.data.image}
              imageAlt={post.data.imageAlt}
            />
          </div>
        ))}
      </div>
    </div>
  </section>

  <script>
    // Lance l'initialisation une fois le DOM rendu (script en fin de page).
    InitialiserRechercheArticles();

    // Initialise les écouteurs de la barre de recherche pour filtrer les cartes côté client.
    function InitialiserRechercheArticles() {
      const champRecherche = document.querySelector('#recherche-articles');
      if (!champRecherche) {
        return;
      }
      const cartesArticles = document.querySelectorAll('[data-titre-article]');
      champRecherche.addEventListener('input', () => {
        FiltrerArticlesParTitre(champRecherche.value, cartesArticles);
      });
    }

    // Filtre les cartes selon le texte saisi afin de masquer celles qui ne correspondent pas au titre recherché.
    function FiltrerArticlesParTitre(texteRecherche, cartesArticles) {
      const termeNormalise = texteRecherche.trim().toLowerCase();
      cartesArticles.forEach((carte) => {
        const titreCarte = carte.dataset.titreArticle ?? '';
        const doitMasquer = termeNormalise !== '' && !titreCarte.includes(termeNormalise);
        carte.classList.toggle('d-none', doitMasquer);
      });
    }
  </script>
</Layout>
