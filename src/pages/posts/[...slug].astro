---
import Layout from '../../layouts/Layout.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  // Point d'entree Astro pour generer les routes statiques (nom impose par Astro).
  const posts = await getCollection('posts');
  return posts.map((post) => ({ params: { slug: post.slug }, props: { post } }));
}

const { post } = Astro.props;
const { Content } = await post.render();

// Formate la date pour l'en-tete de l'article.
const FormaterDateArticle = (date: Date) =>
  new Intl.DateTimeFormat('fr-FR', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  }).format(date);

---

<Layout
  title={post.data.title}
  description={post.data.metaDescription}
  keywords={post.data.keywords}
  image={post.data.image}
>
  <article class="py-5">
    <div class="container">
      <div class="row justify-content-center">
        <div class="col-12 col-lg-9">
          <header class="mb-4">
            <div class="d-flex flex-wrap align-items-center gap-3 mb-3">
              <span class="badge text-bg-primary text-uppercase">{post.data.category}</span>
              <time class="text-muted small" datetime={post.data.date.toISOString()}>
                {FormaterDateArticle(post.data.date)}
              </time>
              <span class="text-muted small">Par {post.data.author}</span>
              <span class="text-muted small">{post.data.readingTime}</span>
            </div>

            <h1 class="display-6 fw-bold mb-3">{post.data.title}</h1>
            <p class="fs-5 text-muted mb-3">{post.data.subtitle}</p>

            <div class="text-muted small">
              <span class="fw-semibold text-primary">Source : {post.data.source}</span>
            </div>
          </header>

          <figure class="mb-5">
            <div class="rounded-3 shadow-sm overflow-hidden" style="height: 320px;">
              <img
                src={post.data.image}
                alt={post.data.imageAlt}
                class="w-100 h-100 object-fit-cover"
                loading="eager"
                decoding="async"
              />
            </div>
            <figcaption class="text-muted small mt-2">{post.data.imageCaption}</figcaption>
          </figure>

          <div class="fs-6 lh-lg text-body mb-5" data-article-content>
            <Content />
          </div>

          <footer class="border-top pt-4">
            <a href="/" class="btn btn-outline-primary">
              ← Retour aux articles
            </a>
          </footer>
        </div>
      </div>
    </div>
  </article>

  <script>
    // Masque les illustrations suggérées n°1 dans le rendu article.
    function MasquerIllustrationSuggereeNumeroUn() {
      const contenu = document.querySelector('[data-article-content]');
      if (!contenu) return;
      contenu.querySelectorAll('p, li').forEach((bloc) => {
        if (!/illustration suggérée n°1/i.test(bloc.textContent ?? '')) return;
        const suivant = bloc.nextElementSibling;
        bloc.remove();
        if (suivant?.tagName === 'P' && suivant.querySelector('img') && !suivant.textContent?.trim()) {
          suivant.remove();
        }
      });
      contenu.querySelectorAll('p').forEach((bloc) => {
        if (bloc.querySelectorAll('img').length !== 1 || bloc.textContent?.trim()) return;
        const suivant = bloc.nextElementSibling;
        if (/^H[1-6]$/.test(suivant?.tagName ?? '') && /sources?/i.test(suivant?.textContent ?? '')) {
          bloc.remove();
        }
      });
    }
    MasquerIllustrationSuggereeNumeroUn();
  </script>
</Layout>
